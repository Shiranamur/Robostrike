@page "/hub"
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation
@rendermode InteractiveServer

<h3>Hub de jeu</h3>

<div class="hub-controls">
    <button @onclick="JoinMatchmaking" disabled="@(jsInitialized ? null : true)">Rejoindre le matchmaking</button>
    <button @onclick="LeaveMatchmaking" disabled="@(jsInitialized ? null : true)">Quitter le matchmaking</button>
</div>

<div class="hub-status">
    <p>@statusMessage</p>
</div>

<div id="gameContainer" style="width:480px; height:480px; border:1px solid #ccc;"></div>

@code {
    private string statusMessage = "Bienvenue sur le hub de jeu.";
    private string sessionToken = string.Empty;
    private bool jsInitialized = false;
    private CancellationTokenSource pollingCts;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Task.Delay(100);
            sessionToken = await JS.InvokeAsync<string>("localStore.get", "sessionToken");
            if (string.IsNullOrWhiteSpace(sessionToken))
            {
                Navigation.NavigateTo("/login");
                return;
            }
            else
            {
                statusMessage = "Token récupéré avec succès.";
            }
            jsInitialized = true;
            StateHasChanged();
        }
    }

    private async Task JoinMatchmaking()
    {
        try
        {
            if (!jsInitialized || string.IsNullOrWhiteSpace(sessionToken))
            {
                statusMessage = "Token de session introuvable.";
                Navigation.NavigateTo("/login");
                return;
            }

            Http.DefaultRequestHeaders.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", sessionToken);

            Console.WriteLine("Sending request: Join Matchmaking");
            var joinResponse = await Http.GetAsync("http://localhost:5181/api/matchmaking/join");
            Console.WriteLine($"Join Matchmaking response: {joinResponse.StatusCode}");

            if (joinResponse.IsSuccessStatusCode)
            {
                statusMessage = await joinResponse.Content.ReadAsStringAsync();
                pollingCts = new CancellationTokenSource();
                await PollMatchmakingStatusAsync(pollingCts.Token);
            }
            else
            {
                statusMessage = $"Erreur lors du join: {joinResponse.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            statusMessage = ex.Message;
            Console.WriteLine($"Join Matchmaking exception: {ex}");
        }
    }

    private async Task PollMatchmakingStatusAsync(CancellationToken token)
    {
        bool gameFound = false;
        while (!gameFound && !token.IsCancellationRequested)
        {
            try
            {
                Console.WriteLine("Sending request: Poll Matchmaking Status");
                var statusResponse = await Http.GetAsync("http://localhost:5181/api/matchmaking/status", token);
                Console.WriteLine($"Poll Matchmaking Status response: {statusResponse.StatusCode}");

                if (statusResponse.IsSuccessStatusCode) //take msg instead of response status code
                {
                    var resultJson = await statusResponse.Content.ReadAsStringAsync();
                    if (resultJson.Contains("matchId"))
                    {
                        statusMessage = $"Vous avez rejoint la partie : {resultJson}";
                        await JS.InvokeVoidAsync("initializeGameCanvas", "gameContainer");
                        gameFound = true;
                        StateHasChanged();
                        break;
                    }
                    else
                    {
                        statusMessage = "En attente... " + resultJson;
                        StateHasChanged();
                    }
                }
                else
                {
                    statusMessage = $"Erreur du statut: {statusResponse.StatusCode}";
                    StateHasChanged();
                }
            }
            catch (TaskCanceledException)
            {
                statusMessage = "Long polling annulé.";
                Console.WriteLine("Polling was cancelled.");
                StateHasChanged();
                break;
            }
            catch (Exception ex)
            {
                statusMessage = ex.Message;
                Console.WriteLine($"Polling exception: {ex}");
                StateHasChanged();
            }

            await Task.Delay(2000, token);
        }
    }

    private async Task LeaveMatchmaking()
    {
        try
        {
            pollingCts?.Cancel();

            Http.DefaultRequestHeaders.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", sessionToken);

            Console.WriteLine("Sending request: Leave Matchmaking");
            var leaveResponse = await Http.GetAsync("http://localhost:5181/api/matchmaking/leave");
            Console.WriteLine($"Leave Matchmaking response: {leaveResponse.StatusCode}");

            if (leaveResponse.IsSuccessStatusCode)
            {
                statusMessage = await leaveResponse.Content.ReadAsStringAsync();
            }
            else
            {
                statusMessage = $"Erreur lors du leave: {leaveResponse.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            statusMessage = ex.Message;
            Console.WriteLine($"Leave Matchmaking exception: {ex}");
        }
    }
}
