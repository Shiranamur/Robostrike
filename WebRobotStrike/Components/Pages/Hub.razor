@page "/hub"
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation
@rendermode InteractiveServer

<h3>Hub de jeu</h3>

<div class="hub-controls">
    <button @onclick="JoinMatchmaking" disabled="@(_jsInitialized ? null : true)">Rejoindre le matchmaking</button>
    <button @onclick="LeaveMatchmaking" disabled="@(_jsInitialized ? null : true)">Quitter le matchmaking</button>
</div>

<div class="hub-status">
    <p>@_statusMessage</p>
</div>

<div id="gameContainer" style="width:480px; height:480px; border:1px solid #ccc;"></div>

@code {
    private string _statusMessage = "Bienvenue sur le hub de jeu.";
    private string _sessionToken = string.Empty;
    private bool _jsInitialized = false;
    private CancellationTokenSource _pollingCts;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Task.Delay(100);
            _sessionToken = await JS.InvokeAsync<string>("localStore.get", "sessionToken");
            if (string.IsNullOrWhiteSpace(_sessionToken))
            {
                Navigation.NavigateTo("/login");
                return;
            }
            else
            {
                _statusMessage = "Token récupéré avec succès.";
            }
            _jsInitialized = true;
            StateHasChanged();
        }
    }

    private async Task JoinMatchmaking()
    {
        try
        {
            if (!_jsInitialized || string.IsNullOrWhiteSpace(_sessionToken))
            {
                _statusMessage = "Token de session introuvable.";
                Navigation.NavigateTo("/login");
                return;
            }

            Http.DefaultRequestHeaders.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", _sessionToken);

            Console.WriteLine("Sending request: Join Matchmaking");
            var joinResponse = await Http.GetAsync("http://localhost:5181/api/matchmaking/join");
            Console.WriteLine($"Join Matchmaking response: {joinResponse.StatusCode}");

            if (joinResponse.IsSuccessStatusCode)
            {
                _statusMessage = await joinResponse.Content.ReadAsStringAsync();
                _pollingCts = new CancellationTokenSource();
                await PollMatchmakingStatusAsync(_pollingCts.Token);
            }
            else
            {
                _statusMessage = $"Erreur lors du join: {joinResponse.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            _statusMessage = ex.Message;
            Console.WriteLine($"Join Matchmaking exception: {ex}");
        }
    }

    private async Task PollMatchmakingStatusAsync(CancellationToken token)
    {
        bool gameFound = false;
        while (!gameFound && !token.IsCancellationRequested)
        {
            try
            {
                Console.WriteLine("Sending request: Poll Matchmaking Status");
                var statusResponse = await Http.GetAsync("http://localhost:5181/api/matchmaking/status", token);
                Console.WriteLine($"Poll Matchmaking Status response: {statusResponse.StatusCode}");

                if (statusResponse.IsSuccessStatusCode) //take msg instead of response status code
                {
                    var resultJson = await statusResponse.Content.ReadAsStringAsync();
                    if (resultJson.Contains("matchId"))
                    {
                        _statusMessage = $"Vous avez rejoint la partie : {resultJson}";
                        await JS.InvokeVoidAsync("initializeGameCanvas", "gameContainer");
                        gameFound = true;
                        StateHasChanged();
                        break;
                    }
                    else
                    {
                        _statusMessage = "En attente... " + resultJson;
                        StateHasChanged();
                    }
                }
                else
                {
                    _statusMessage = $"Erreur du statut: {statusResponse.StatusCode}";
                    StateHasChanged();
                }
            }
            catch (TaskCanceledException)
            {
                _statusMessage = "Long polling annulé.";
                Console.WriteLine("Polling was cancelled.");
                StateHasChanged();
                break;
            }
            catch (Exception ex)
            {
                _statusMessage = ex.Message;
                Console.WriteLine($"Polling exception: {ex}");
                StateHasChanged();
            }

            await Task.Delay(2000, token);
        }
    }

    private async Task LeaveMatchmaking()
    {
        try
        {
            _pollingCts?.Cancel();

            Http.DefaultRequestHeaders.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", _sessionToken);

            Console.WriteLine("Sending request: Leave Matchmaking");
            var leaveResponse = await Http.GetAsync("http://localhost:5181/api/matchmaking/leave");
            Console.WriteLine($"Leave Matchmaking response: {leaveResponse.StatusCode}");

            if (leaveResponse.IsSuccessStatusCode)
            {
                _statusMessage = await leaveResponse.Content.ReadAsStringAsync();
            }
            else
            {
                _statusMessage = $"Erreur lors du leave: {leaveResponse.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            _statusMessage = ex.Message;
            Console.WriteLine($"Leave Matchmaking exception: {ex}");
        }
    }
}
